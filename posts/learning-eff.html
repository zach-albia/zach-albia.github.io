<!DOCTYPE html><html lang="en"><head><meta charSet="UTF-8"/><title>Learning Eff - zach-albia.github.io</title><meta name="description" content="Next.js starter blog"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="alternate" title="RSS Feed" type="application/json" href="https://zach-albia.github.io/feed.json"/><meta property="og:url" content="https://zach-albia.github.io"/><meta property="og:title" content="Learning Eff"/><meta property="og:description" content="Next.js starter blog"/><meta name="twitter:site" content="https://zach-albia.github.io"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://zach-albia.github.io/static/site-feature.png"/><meta property="og:image" content="https://zach-albia.github.io/static/site-feature.png"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/j1ueu67XSefpcnR98rryX/pages/posts/learning-eff.js" as="script"/><link rel="preload" href="/_next/static/j1ueu67XSefpcnR98rryX/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-91b117697e716c22a78b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.74d547792b3163b4d6d2.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.6b5b42654657d9aebcbb.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-585248bbf88b18432f6a.js" as="script"/><link rel="preload" href="/_next/static/chunks/96b6526e.a10b20af608fdac87cca.js" as="script"/><link rel="preload" href="/_next/static/chunks/f549ad2dcf6c9c5ffbba747589d169db97ccff2b.5903a973e4c876611b30.js" as="script"/><link rel="preload" href="/_next/static/chunks/f041c2740afecc650b3ad9ef54274eb23f155db1.ede9e800f277f0f3ce47.js" as="script"/><style id="__jsx-35041104">h1.jsx-35041104{margin-top:0;}a.jsx-35041104{color:#333;-webkit-text-decoration:none;text-decoration:none;}p.jsx-35041104{font-size:1.3em;font-weight:bold;}</style><style id="__jsx-3928104162">nav.jsx-3928104162{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}a.jsx-3928104162:not(:last-child){margin-right:1em;}</style><style id="__jsx-1260337168">header.jsx-2576568336{padding:1em 0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}</style><style id="__jsx-1749265417">html{margin:0;box-sizing:border-box;}*,*:before,*:after{box-sizing:inherit;}body{margin:0;font-size:18px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto, Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;color:#333;line-height:1.5;background-color:#fff;}h1,h2,h3,h4{margin-bottom:0.5rem;font-weight:bold;color:inherit;line-height:1.25;}h1{font-size:2rem;}h2{margin-top:1rem;font-size:1.8rem;}h3{margin-top:1.5rem;font-size:1.5rem;}p{margin-top:0;margin-bottom:1rem;}ul,ol,dl{margin-top:0;margin-bottom:1rem;}a{color:#33e;cursor:pointer;}a:hover,a:focus{-webkit-text-decoration:underline;text-decoration:underline;}hr{position:relative;margin:1.5em 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff;}blockquote{padding:0.5em 1em;margin:0.8em 0;color:#555;border-left:0.25em solid #ccc;}blockquote p:last-child{margin-bottom:0;}pre code{font-size:18px;}code{color:#fff;}.wrap{max-width:38rem;margin-left:auto;margin-right:auto;}article img{max-width:100%;height:auto;}</style><style id="__jsx-2086094107">code[class*='language-'],pre[class*='language-']{color:#f8f8f2;background:none;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}pre[class*='language-']{padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em;}:not(pre)>code[class*='language-'],pre[class*='language-']{background:#2b2b2b;}:not(pre)>code[class*='language-']{padding:0.1em;border-radius:0.3em;white-space:normal;}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:#d4d0ab;}.token.punctuation{color:#fefefe;}.token.property,.token.tag,.token.constant,.token.symbol,.token.deleted{color:#ffa07a;}.token.boolean,.token.number{color:#00e0e0;}.token.selector,.token.attr-name,.token.string,.token.char,.token.builtin,.token.inserted{color:#abe338;}.token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string,.token.variable{color:#00e0e0;}.token.atrule,.token.attr-value,.token.function{color:#ffd700;}.token.keyword{color:#00e0e0;}.token.regex,.token.important{color:#ffd700;}.token.important,.token.bold{font-weight:bold;}.token.italic{font-style:italic;}.token.entity{cursor:help;}@media screen and (-ms-high-contrast:active){code[class*='language-'],pre[class*='language-']{color:windowText;background:window;}:not(pre)>code[class*='language-'],pre[class*='language-']{background:window;}.token.important{background:highlight;color:window;font-weight:normal;}.token.atrule,.token.attr-value,.token.function,.token.keyword,.token.operator,.token.selector{font-weight:bold;}.token.attr-value,.token.comment,.token.doctype,.token.function,.token.keyword,.token.operator,.token.property,.token.string{color:highlight;}.token.attr-value,.token.url{font-weight:normal;}}code{padding:0.1em 0.2em;background-color:#2b2b2b;border-radius:0.3em;}code[class*='language-'],pre[class*='language-']{font-size:16px;line-height:1.3;}pre[class*='language-']{margin-bottom:1em;}pre[class='language-jsx']{padding-bottom:0;}.mdx-marker{background-color:rgba(255,255,255,0.1);display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffdc00;}</style><style id="__jsx-2576154369">a.jsx-2576154369{color:#555;-webkit-text-decoration:none;text-decoration:none;}</style><style id="__jsx-3237423915">a.jsx-3237423915{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column; ;}</style><style id="__jsx-1238384267">header.jsx-1238384267{margin-bottom:2em;}[rel='author'].jsx-1238384267{margin-left:1em;}article.jsx-1238384267{margin-bottom:2em;}footer.jsx-1238384267{margin-top:2em;}.post-pagination.jsx-1238384267{display:grid;grid-template-columns:1fr 1fr;}</style><style id="__jsx-140955737">.profile.jsx-140955737{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:1em;background-color:#eee;}img.jsx-140955737{width:5em;height:5em;margin-right:0.5em;}p.jsx-140955737:last-child{margin-bottom:0;}</style><style id="__jsx-3055961061">footer.jsx-3055961061{padding:1em 0;}p.jsx-3055961061{margin-top:2em;}</style><style id="__jsx-3779335083">.jsx-3779335083{max-width:45rem;margin:0 auto;padding:0 1em;}</style></head><body><div id="__next"><div class="jsx-3779335083"><header class="jsx-2576568336"><p class="jsx-35041104"><a rel="me" class="jsx-35041104" href="/">zach-albia.github.io</a></p><nav class="jsx-3928104162"><a class="jsx-3928104162" href="/about">About</a></nav></header><main><article class="jsx-1238384267 h-entry"><header class="jsx-1238384267"><h1 class="jsx-1238384267 p-name">Learning Eff</h1><div class="jsx-1238384267"><a href="/posts/learning-eff" mcolor="#aaa" date="2017-10-31" link="/posts/learning-eff" class="jsx-2576154369 u-url"><time class="jsx-2576154369 dt-published">October 31, 2017</time></a><a color="#aaa" rel="author" href="/about" class="jsx-1238384267 p-author h-card">Zachary Albia</a></div></header><div class="jsx-1238384267 e-content"><div><h1>Introduction</h1><p>Learning how to use <a href="https://github.com/atnos-org/eff">Eff in Scala</a>, let alone learning how it works on the inside, is quite the challenge for me and I believe for many people too. I feel that there&#x27;s quite the chasm from running a few easy examples to putting together a full app using Eff.</p><p>However, Eff has a great amount of documentation for the initiated FP user in Scala. In fact, there&#x27;s even a set of exercises in <a href="https://github.com/benhutchison/GettingWorkDoneWithExtensibleEffects/"><em>&quot;Getting Work Done With Extensible Effects&quot;</em></a> that guide you in a methodical way towards understanding how you might use Eff in a real, non-trivial app. There&#x27;s even <a href="https://vimeo.com/channels/flatmap2016/165927840">a great presentation</a> about a practical way to use Eff in bigger projects, though I&#x27;ve yet to see the usage of the overall framework described in it in a sample application. I hope there&#x27;s one out there and I hope I just missed it. Or maybe it&#x27;s not needed at all.</p><p>That said, I think there&#x27;s still a part of that chasm that needs to be covered. It&#x27;s somewhere in between someone starting out with FP in Scala and the aforementioned exercises by Ben Hutchinson. I think there&#x27;s some value in going back to the simplest problems and seeing what Eff looks like there.</p><p>I&#x27;m planning to have this series span the first set of adriannn&#x27;s <a href="https://adriann.github.io/programming_problems.html">Simple Programming Problems</a>, namely the <em>Elementary Problems</em>. <a href="https://github.com/zach-albia/learning-eff">This series&#x27; code</a> is available on Github. We kick things off with our first problem:</p><blockquote><p>Write a program that prints ‘Hello World’ to the screen.</p></blockquote><h1>Many ways to say Hello</h1><h2>The simplest way</h2><p>Our first jab at the problem begins with the simplest possible example that we&#x27;re taught when we first learn to program in any language. Our first problem happens to be Scala&#x27;s Hello World:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">object</span> Prob01Pass01 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>It&#x27;s simple, but inflexible. You can only ever print to the console here. Period. What if we wanted to print <code>&quot;Hello World&quot;</code> to a file? Also, how do we know it works? We run it, and it prints <code>Hello World</code> to the console. But we did have to look at the characters it prints out. And we did have to make sure <em>every single character</em> lines up to make the string <code>&quot;Hello World&quot;</code>. We aren&#x27;t exactly perfect at reading either, and our eyes can trip and think we&#x27;re reading the right string when we&#x27;re not!</p><p>If it can happen to us in a simple &quot;Hello World&quot;, imagine what would happen if we had to do it for any bigger program. We say we <strong>cannot test</strong> <code>main</code>. It&#x27;s opaque to any testing effort unless we go to great lengths just to read the output on the console itself. Let&#x27;s see if we can test one of the simplest programs ever.</p><h2>The <em>testable</em> way</h2><p>At the heart of software development is getting things done <em>automatically</em>. That includes testing. We have to restructure our tiny Hello World app so we can run a test:</p><ol><li>to see if our program compiles,</li><li>to see if it works as expected without having to look at our program&#x27;s console output, and</li><li>to be able to automatically do both 1 &amp; 2 repeatedly.</li></ol><p>Here is one way to refactor our code:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">object</span> Prob01Pass02 <span class="token punctuation">{</span>
  <span class="token keyword">val</span> defaultPrintln<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> Predef<span class="token punctuation">.</span>println

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
    printHelloWorld<span class="token punctuation">(</span>defaultPrintln<span class="token punctuation">)</span>

  <span class="token keyword">def</span> printHelloWorld<span class="token punctuation">(</span>println<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Unit</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Note that <code>println</code> is now totally <em>divorced</em> from the concept of the console. We might as well write <code>&quot;Hello World&quot;</code> in crop circles, given the right <code>println</code>. More practically, now we can write code to test <code>printHelloWorld</code>.</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">import</span> Prob01Pass01<span class="token punctuation">.</span>printHelloWorld
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>scalatest</span><span class="token punctuation">.</span>_

<span class="token keyword">class</span> Prob01Spec <span class="token keyword">extends</span> FlatSpec <span class="token keyword">with</span> Matchers <span class="token punctuation">{</span>

  <span class="token keyword">val</span> mockPrintln<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> _ should be <span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span>

  <span class="token string">&quot;our second pass at printHelloWorld&quot;</span> should
      <span class="token string">&quot;print hello world to a println function&quot;</span> in <span class="token punctuation">{</span>
    Prob01Pass02<span class="token punctuation">.</span>printHelloWorld<span class="token punctuation">(</span>_ should be <span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Our test code <em>intercepts</em> what&#x27;s passed to our function. This allows us to automatically confirm that, for whatever way we can print <code>&quot;Hello World&quot;</code>, <code>println</code> will receive <em>exactly</em> the string <code>&quot;Hello World&quot;</code> and <em>nothing else</em>.</p><h2>The <em>Reader</em> way</h2><p><code>printHelloWorld</code> is a function that takes a <code>println</code> function and runs it on <code>&quot;Hello World&quot;</code>, giving back <code>Unit</code>. Reader is just an effect in the form of a function taking one parameter which yields our value, the return value. Let&#x27;s look at our testable code in terms of Reader:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">import</span> <span class="token namespace">cats<span class="token punctuation">.</span>data</span><span class="token punctuation">.</span>Reader

<span class="token keyword">object</span> Prob01Pass03 <span class="token punctuation">{</span>
  <span class="token keyword">val</span> defaultPrintln<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> Predef<span class="token punctuation">.</span>println

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> program <span class="token operator">=</span> printHelloWorld

    <span class="token comment">// at the end of the world</span>
    program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>defaultPrintln<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> printHelloWorld<span class="token operator">:</span> Reader<span class="token punctuation">[</span><span class="token builtin">String</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Unit</span><span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    Reader <span class="token punctuation">{</span> println <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Our code is very similar to our second pass. Note that we only had to change a little bit of code Since <code>Reader</code> and a function with one parameter, namely <code>Function1[A, B]</code> or <code>A =&gt; B</code> in Scala, are practically one and the same. In our usage of <code>Reader</code> here, we mean it to <em>delay reading or asking for</em>  a <code>println</code>  function in order to <em>return</em> <code>Unit</code>, i.e. to make some side effect(s). I think &quot;Reader&quot; is a weird name for it. It&#x27;d probably make more sense as the &quot;Context&quot;, &quot;Config&quot; or &quot;Dependency&quot;. But what do I know?</p><p><code>Reader</code> also allows us to write tests:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token string">&quot;our third pass at printHelloWorld&quot;</span> should
    <span class="token string">&quot;be a flexible hello world program&quot;</span> in <span class="token punctuation">{</span>
  <span class="token keyword">val</span> program <span class="token operator">=</span> Prob01Pass03<span class="token punctuation">.</span>printHelloWorld

  program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>_ should be <span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>By using <code>Reader</code> , in <code>main</code> we end up with a pure <em>description</em> of our &quot;Hello World&quot; program in <code>program</code>. A pure program that we can interpret, or <code>run</code> any way we want.</p><p>It&#x27;s pure in the sense that we can call <code>printHelloWorld</code> any number of times and it won&#x27;t have any side effects, and will <em>always</em> return the same program. I&#x27;ve read a lot of material with the idea that <em>functional programs are descriptions of programs that you run</em>. This looks like it fits the bill.</p><p>We can interpret our program in another way with the use of a <em>&quot;fake&quot;</em> or a <em>&quot;mock&quot;</em> <code>println</code>--one that just checks if it got passed <code>&quot;Hello World&quot;</code>. We could even interpret <code>printHelloWorld</code> to print the line to a file, or write a smoke message in the sky with an autonomous drone given the right <code>println</code> function.</p><p>What does Reader buy us? There is some extra cognitive overhead here for sure. We&#x27;ve had to learn Reader when we could have just stuck to our second pass by just passing functions. We&#x27;ve gained <em>the flexibility and the concept</em> of a pure program, one that could be interpreted in many ways, one of which is useful for testing. What else can we gain?</p><h2>The <em>Reader-Writer</em> way</h2><p>Say, for our fourth pass, we wanted to know how fast &quot;Hello World&quot; runs on our computer. The simplest, non-testable way looks something like this:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">object</span> Prob01Pass04 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> time <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
    println<span class="token punctuation">(</span>s<span class="token string">&quot;Ran hello world in $time ms.&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Our problem with this code is that it doesn&#x27;t easily allow us to change <em>how</em> we print &quot;Hello World&quot;, as well as <em>how</em> we read the time. <code>System.getCurrentTimeMillis</code> and <code>println</code> here are impure functions. <code>System.getCurrentTimeMillis</code> observes the side effect of passing time while <code>println</code> has the side effect of writing to a console. Consequently, besides testing Hello World, we can&#x27;t test if it&#x27;s logging the right amount of time.</p><p>Let&#x27;s make an <code>AppConfig</code> trait and give it the default console and system time version that we can use in <code>main</code>:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">trait</span> AppConfig <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@throws</span><span class="token punctuation">(</span>classOf<span class="token punctuation">[</span>Exception<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> println<span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>
  <span class="token keyword">def</span> startTimeMillis<span class="token operator">:</span> <span class="token builtin">Long</span>
  <span class="token keyword">def</span> endTimeMillis<span class="token operator">:</span> <span class="token builtin">Long</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> AppConfig <span class="token punctuation">{</span>
  <span class="token keyword">val</span> default<span class="token operator">:</span> AppConfig <span class="token operator">=</span> <span class="token keyword">new</span> AppConfig <span class="token punctuation">{</span>
    <span class="token keyword">def</span> println<span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> Predef<span class="token punctuation">.</span>println<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">def</span> startTimeMillis<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> endTimeMillis<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Note that we&#x27;ve declared that our <code>println</code> can fail. This is due to <code>println</code> being flexible enough for this to happen. Now that we have <code>AppConfig</code> nailed down, let&#x27;s see what we can do with <code>Reader</code> and <code>Writer</code>:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">import</span> cats<span class="token punctuation">.</span>_<span class="token punctuation">,</span> cats<span class="token punctuation">.</span>data<span class="token punctuation">.</span>_<span class="token punctuation">,</span> cats<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span>_
<span class="token keyword">import</span> Writer<span class="token punctuation">.</span>_

<span class="token keyword">object</span> Prob01Pass05 <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> program <span class="token operator">=</span> printHelloWorld

    <span class="token comment">// at the end of the world</span>
    <span class="token keyword">val</span> <span class="token punctuation">(</span>timeElapsed<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>AppConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">.</span>run
    println<span class="token punctuation">(</span>s<span class="token string">&quot;Ran hello world in $timeElapsed ms.&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> printHelloWorld<span class="token operator">:</span> Reader<span class="token punctuation">[</span>AppConfig<span class="token punctuation">,</span> Writer<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    Reader <span class="token punctuation">{</span> appCfg <span class="token keyword">=&gt;</span>
      <span class="token keyword">for</span> <span class="token punctuation">{</span>
        _ <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span><span class="token operator">-</span>appCfg<span class="token punctuation">.</span>startTimeMillis<span class="token punctuation">)</span>
        _ <span class="token keyword">&lt;-</span> value<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">(</span>appCfg<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        _ <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span>appCfg<span class="token punctuation">.</span>endTimeMillis<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Looking at <code>main</code>, <code>printHelloWorld</code> is run twice. That&#x27;s because our program now has <em>two</em> effects, <code>Reader</code> and <code>Writer</code>. Our third pass only had <code>Reader</code> so we&#x27;ve only had to call <code>run</code> once. In FP, pure programs like <code>printHelloWorld</code> will be run or <em>interpreted</em> as many times as it has effects. Once we <em>interpret</em> all those effects, we end up with the output of our pure program, in this case, a <code>(Long, Unit)</code> tuple, the first part of which contains our <code>timeElapsed</code> in milliseconds.</p><p>With <code>AppConfig</code>, <code>Reader</code>, and <code>Writer</code>, we&#x27;ve decoupled our code from the console and the system clock. Note that we&#x27;ve had to manually <code>println</code> our <code>timeElapsed</code> report in <code>main</code>, since the second <code>run</code> produces a pure log of <code>timeElapsed</code>.</p><p>With this, we can write a test for our fifth pass that checks both printing Hello World and logging the time.</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">object</span> MockAppConfig <span class="token keyword">extends</span> AppConfig <span class="token punctuation">{</span>
  <span class="token keyword">def</span> println<span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> s should be <span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">def</span> endTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token string">&quot;our fifth pass at printHelloWorld&quot;</span> should
    <span class="token string">&quot;be a flexible, timed hello world program&quot;</span> in <span class="token punctuation">{</span>
  <span class="token keyword">val</span> program <span class="token operator">=</span> Prob01Pass05<span class="token punctuation">.</span>printHelloWorld

  <span class="token keyword">val</span> <span class="token punctuation">(</span>timeElapsed<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>MockAppConfig<span class="token punctuation">)</span><span class="token punctuation">.</span>run
  timeElapsed should be <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Let&#x27;s take a closer look at our <code>printHelloWorld</code> program itself.</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">val</span> printHelloWorld<span class="token operator">:</span> Reader<span class="token punctuation">[</span>AppConfig<span class="token punctuation">,</span> Writer<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span>
  Reader <span class="token punctuation">{</span> appCfg <span class="token keyword">=&gt;</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
      _ <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span><span class="token operator">-</span>appCfg<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
      _ <span class="token keyword">&lt;-</span> value<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">(</span>appCfg<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      _ <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span>appCfg<span class="token punctuation">.</span>endTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><p>We have a stack of two effects, Reader &amp; Writer. Our <code>Writer</code> needs access to <code>appCfg</code> to log the time, which means <code>Reader</code> has to be on the top of our effect stack. Note how we&#x27;ve had to manually stack our <code>Writer</code> program inside our <code>Reader</code>. Though we did also gain the ability for our computation (printing Hello World, mind you), to have multiple effects.</p><p>If we had to stack more effects, our pure program code would get more and more unwieldy and shift further and further to the right. To illustrate this, let&#x27;s have a go at adding error handling to our stack.</p><h2>The <em>Reader-Writer-Either</em> Way</h2><p>Our <code>println</code> can throw an exception, as declared in <code>AppConfig</code>. After all, we could have our pure program tell a rover on Mars to print &quot;Hello World&quot; on Martian sand, again given the right <code>println</code>function. We could very easily lose our connection to the rover! As programmers, we have to be prepared for this scenario. Let&#x27;s add error-handling to our stack.</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">import</span> <span class="token namespace">cats<span class="token punctuation">.</span>data</span><span class="token punctuation">.</span>_<span class="token punctuation">,</span> cats<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span>_
<span class="token keyword">import</span> Writer<span class="token punctuation">.</span>_

<span class="token keyword">object</span> Prob01Pass06 <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> program <span class="token operator">=</span> printHelloWorld

    <span class="token comment">// at the end of the world</span>
    <span class="token keyword">val</span> <span class="token punctuation">(</span>timeElapsed<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token operator">=</span> program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>AppConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">.</span>run
    result <span class="token keyword">match</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> Left<span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span>s<span class="token string">&quot;Hello world failed: $e&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> _       <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span>s<span class="token string">&quot;Ran hello world in $timeElapsed ms.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">type</span> ReaderWriterEither<span class="token punctuation">[</span>A<span class="token punctuation">]</span> <span class="token operator">=</span>
    Reader<span class="token punctuation">[</span>AppConfig<span class="token punctuation">,</span> Writer<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">,</span> Either<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> A<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

  <span class="token keyword">val</span> printHelloWorld<span class="token operator">:</span> ReaderWriterEither<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    Reader <span class="token punctuation">{</span> appCfg <span class="token keyword">=&gt;</span>
      <span class="token keyword">for</span> <span class="token punctuation">{</span>
        _ <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span><span class="token operator">-</span>appCfg<span class="token punctuation">.</span>startTimeMillis<span class="token punctuation">)</span>
        e <span class="token keyword">&lt;-</span> value<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">,</span> Either<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Right<span class="token punctuation">(</span>appCfg<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> Left<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        _ <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span>appCfg<span class="token punctuation">.</span>endTimeMillis<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">yield</span> e
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Note that in <code>main</code>, after we <em>run</em> or <em>remove a layer</em> from the pure program twice, we have one last layer in error handling. We have to handle any errors that might have occurred during the course of its execution.</p><p>Our hand-rolled <code>ReaderWriterEither[A]</code> stack now contains <code>Reader[AppConfig, ?]</code>, <code>Writer[Long, ?]</code> and <code>Either[Throwable, ?]</code>. Note how we&#x27;ve had to have <em>yet another level of indentation</em> just to support error handling. </p><p>A test for this code looks like:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">object</span> MockUnreachableRover <span class="token keyword">extends</span> AppConfig <span class="token punctuation">{</span>
  <span class="token keyword">val</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;Couldn&#x27;t connect to Mars!&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> println<span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token keyword">throw</span> exception <span class="token comment">// this matters</span>
  <span class="token keyword">def</span> startTimeMillis<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// these values</span>
  <span class="token keyword">def</span> endTimeMillis<span class="token operator">:</span>   <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// don&#x27;t matter</span>
<span class="token punctuation">}</span>

<span class="token string">&quot;our sixth pass at printHelloWorld&quot;</span> should
    <span class="token string">&quot;be a flexible, timed, resilient hello world program&quot;</span> in <span class="token punctuation">{</span>
  <span class="token keyword">val</span> program <span class="token operator">=</span> Prob01Pass06<span class="token punctuation">.</span>printHelloWorld

  <span class="token keyword">val</span> <span class="token punctuation">(</span>timeElapsed<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>MockAppConfig<span class="token punctuation">)</span><span class="token punctuation">.</span>run
  timeElapsed should be <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

  <span class="token keyword">val</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token operator">=</span> program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>MockUnreachableRover<span class="token punctuation">)</span><span class="token punctuation">.</span>run
  result should be <span class="token punctuation">(</span>Left<span class="token punctuation">(</span>MockUnreachableRover<span class="token punctuation">.</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Our tests say it all. We now have a Hello World program that&#x27;s flexible (allowing any <code>println</code>), timed (in ms), and resilient (by catching errors). By now we should be able to say it&#x27;s all worth it. If we know how to imbue our humble Hello World program with these qualities, we now stand a chance at ensuring all our functional programs have the same qualities. But our <code>printHelloWorld</code> already looks rather <em>tedious</em>. Scale it to any bigger program and it becomes a maintenance and readability nightmare. There has to be a better way to write functional programs. This calls for a more suitable abstraction.</p><h2>The <em>Monad Transformer</em> Way</h2><p>One way is to use monad transformers to flatten our for-comprehension:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">import</span> <span class="token namespace">cats<span class="token punctuation">.</span>data</span><span class="token punctuation">.</span>_
<span class="token keyword">import</span> <span class="token namespace">cats<span class="token punctuation">.</span>implicits</span><span class="token punctuation">.</span>_
<span class="token keyword">import</span> ReaderT<span class="token punctuation">.</span>_
<span class="token keyword">import</span> WriterT<span class="token punctuation">.</span>_

<span class="token keyword">object</span> Prob01Pass07 <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> program <span class="token operator">=</span> printHelloWorld

    <span class="token comment">// at the end of the world</span>
    program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>AppConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">.</span>run <span class="token keyword">match</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> Left<span class="token punctuation">(</span>e<span class="token punctuation">)</span>                   <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span>s<span class="token string">&quot;Hello world failed: $e&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> Right<span class="token punctuation">(</span><span class="token punctuation">(</span>timeElapsed<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">=&gt;</span>
        println<span class="token punctuation">(</span>s<span class="token string">&quot;Ran hello world in $timeElapsed ms.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">type</span> EitherThrowable<span class="token punctuation">[</span>A<span class="token punctuation">]</span> <span class="token operator">=</span> Either<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> A<span class="token punctuation">]</span>
  <span class="token keyword">type</span> WriterLongEither<span class="token punctuation">[</span>A<span class="token punctuation">]</span> <span class="token operator">=</span> WriterT<span class="token punctuation">[</span>EitherThrowable<span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> A<span class="token punctuation">]</span>
  <span class="token keyword">type</span> ReaderWriterEither<span class="token punctuation">[</span>A<span class="token punctuation">]</span> <span class="token operator">=</span> ReaderT<span class="token punctuation">[</span>WriterLongEither<span class="token punctuation">,</span> AppConfig<span class="token punctuation">,</span> A<span class="token punctuation">]</span>

  <span class="token keyword">def</span> printHelloWorld<span class="token operator">:</span> ReaderWriterEither<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
      appConfig <span class="token keyword">&lt;-</span> ask<span class="token punctuation">[</span>WriterLongEither<span class="token punctuation">,</span> AppConfig<span class="token punctuation">]</span>
      _         <span class="token keyword">&lt;-</span> logTime<span class="token punctuation">(</span><span class="token operator">-</span>appConfig<span class="token punctuation">.</span>startTimeMillis<span class="token punctuation">)</span>
      either    <span class="token keyword">&lt;-</span> ReaderT<span class="token punctuation">.</span>lift<span class="token punctuation">[</span>WriterLongEither<span class="token punctuation">,</span> AppConfig<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
                     WriterT<span class="token punctuation">.</span>lift<span class="token punctuation">[</span>EitherThrowable<span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
                       <span class="token keyword">try</span> <span class="token punctuation">{</span>
                         Right<span class="token punctuation">(</span>appConfig<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> e<span class="token operator">:</span> Throwable <span class="token keyword">=&gt;</span>
                         Left<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                       <span class="token punctuation">}</span>
                     <span class="token punctuation">)</span>
                   <span class="token punctuation">)</span>
      _         <span class="token keyword">&lt;-</span> logTime<span class="token punctuation">(</span>appConfig<span class="token punctuation">.</span>endTimeMillis<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">yield</span> either

  <span class="token keyword">def</span> logTime<span class="token punctuation">(</span>time<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> ReaderWriterEither<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">for</span> <span class="token punctuation">{</span>
    _ <span class="token keyword">&lt;-</span> ReaderT<span class="token punctuation">.</span>lift<span class="token punctuation">[</span>WriterLongEither<span class="token punctuation">,</span> AppConfig<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span><span class="token punctuation">(</span>tell<span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>This was a <strong>bitch</strong> to write, and it&#x27;s as clean as I could get it with my limited knowledge of <code>cats</code>. I&#x27;m pretty sure there&#x27;s a way more compact way to write this that involves <code>cats.EitherT</code>. The <code>cats</code> library&#x27;s implicits here mean that anytime we have to use <code>ReaderT</code>&#x27;s functions <code>ask</code> and <code>lift</code>, we&#x27;ve had to specify exactly what it is we&#x27;re stacking a <code>Reader</code> on top of. Otherwise, we get all sorts of nasty compilation errors.</p><p>It is somewhat of an improvement though, in that we&#x27;re able to specify our application logic in <em>only one layer</em> of a for-comprehension. It&#x27;s the lifting part that stings. Stacking together three effects doesn&#x27;t seem to get us the concise code that we want.</p><p>Our test code is fairly trivial and similar to the last one:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token string">&quot;our seventh pass monad transformers printHelloWorld&quot;</span> should
  <span class="token string">&quot;be a flexible, timed, resilient hello world program&quot;</span> in <span class="token punctuation">{</span>
  <span class="token keyword">val</span> program <span class="token operator">=</span> Prob01Pass07<span class="token punctuation">.</span>printHelloWorld

  program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>MockAppConfig<span class="token punctuation">)</span><span class="token punctuation">.</span>run should be <span class="token punctuation">(</span>Right<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  program<span class="token punctuation">.</span>run<span class="token punctuation">(</span>MockUnreachableRover<span class="token punctuation">)</span><span class="token punctuation">.</span>run should be <span class="token punctuation">(</span>Left<span class="token punctuation">(</span>MockUnreachableRover<span class="token punctuation">.</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h2>The <em>Eff Monad</em> Way</h2><p>Let&#x27;s let the code do the talking this time:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">import</span> <span class="token namespace">cats<span class="token punctuation">.</span>data</span><span class="token punctuation">.</span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>atnos<span class="token punctuation">.</span>eff</span><span class="token punctuation">.</span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>atnos<span class="token punctuation">.</span>eff<span class="token punctuation">.</span>all</span><span class="token punctuation">.</span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>atnos<span class="token punctuation">.</span>eff<span class="token punctuation">.</span>syntax<span class="token punctuation">.</span>all</span><span class="token punctuation">.</span>_

<span class="token keyword">object</span> Prob01Pass08 <span class="token punctuation">{</span>

  <span class="token keyword">type</span> Stack <span class="token operator">=</span> Fx<span class="token punctuation">.</span>fx3<span class="token punctuation">[</span>
    Reader<span class="token punctuation">[</span>AppConfig<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    Writer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    Either<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> program <span class="token operator">=</span> printHelloWorld<span class="token punctuation">[</span>Stack<span class="token punctuation">]</span>

    <span class="token comment">// at the end of the world</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Either<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span>
      program
        <span class="token punctuation">.</span>runReader<span class="token punctuation">(</span>AppConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>runWriterUnsafe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>println<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>runEither
        <span class="token punctuation">.</span>run

    result <span class="token keyword">match</span> <span class="token punctuation">{</span> <span class="token comment">// Our program&#x27;s result is a side effect that can fail.</span>
      <span class="token keyword">case</span> Left<span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
        println<span class="token punctuation">(</span>s<span class="token string">&quot;Hello world failed: $e&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">type</span> _appCfg<span class="token punctuation">[</span>R<span class="token punctuation">]</span> <span class="token operator">=</span> Reader<span class="token punctuation">[</span>AppConfig<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span> <span class="token operator">|=</span> R
  <span class="token keyword">type</span> _timeReport<span class="token punctuation">[</span>R<span class="token punctuation">]</span> <span class="token operator">=</span> Writer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span> <span class="token operator">|=</span> R

  <span class="token keyword">def</span> printHelloWorld<span class="token punctuation">[</span>R<span class="token operator">:</span> _appCfg <span class="token operator">:</span> _timeReport <span class="token operator">:</span> _throwableEither<span class="token punctuation">]</span>
      <span class="token operator">:</span> Eff<span class="token punctuation">[</span>R<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">for</span> <span class="token punctuation">{</span>
    appConfig <span class="token keyword">&lt;-</span> ask
    start <span class="token operator">=</span> appConfig<span class="token punctuation">.</span>startTimeMillis
    either    <span class="token keyword">&lt;-</span> catchNonFatalThrowable<span class="token punctuation">(</span>appConfig<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    durationInMs <span class="token operator">=</span> appConfig<span class="token punctuation">.</span>endTimeMillis <span class="token operator">-</span> start
    _         <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span>s<span class="token string">&quot;Ran hello world in $durationInMs ms.&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">yield</span> either
<span class="token punctuation">}</span>
</code></pre><p>It&#x27;s embarrassing how stupidly simple <code>printHelloWorld</code> looks compared to passes 6 and 7. Let&#x27;s break each part down to see how it all works.</p><p>We define our program&#x27;s effect stack using a type declaration as shown below.</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">type</span> Stack <span class="token operator">=</span> Fx<span class="token punctuation">.</span>fx3<span class="token punctuation">[</span>
  Reader<span class="token punctuation">[</span>AppConfig<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  Writer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  Either<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre><p><code>Fx.fx3</code> means we have three effects as shown. Eff supports up to 12 effects stacked with <code>Fx.fx12</code>. Why the seemingly arbitrary selection of 12? I don&#x27;t know. Probably something to do with the Scala compiler? At any rate, we&#x27;ll need this later for <code>main</code> to know how to interpret our pure program. We also need <code>printHelloWorld</code> to declare what sort of effects it needs. Before we do that, we make a couple of type declarations:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">type</span> _appCfg<span class="token punctuation">[</span>R<span class="token punctuation">]</span> <span class="token operator">=</span> Reader<span class="token punctuation">[</span>AppConfig<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span> <span class="token operator">|=</span> R
<span class="token keyword">type</span> _timeReport<span class="token punctuation">[</span>R<span class="token punctuation">]</span> <span class="token operator">=</span> Writer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">]</span> <span class="token operator">|=</span> R
</code></pre><p>We need these since <code>Reader</code> and <code>Writer</code> both accept two type parameters. Now we use them in our <code>printHelloWorld</code> signature:</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">def</span> printHelloWorld<span class="token punctuation">[</span>R<span class="token operator">:</span> _appCfg <span class="token operator">:</span> _timeReport <span class="token operator">:</span> _throwableEither<span class="token punctuation">]</span>
    <span class="token operator">:</span> Eff<span class="token punctuation">[</span>R<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">for</span> <span class="token punctuation">{</span>
  appConfig <span class="token keyword">&lt;-</span> ask
  start <span class="token operator">=</span> appConfig<span class="token punctuation">.</span>startTimeMillis
  either    <span class="token keyword">&lt;-</span> catchNonFatalThrowable<span class="token punctuation">(</span>appConfig<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  durationInMs <span class="token operator">=</span> appConfig<span class="token punctuation">.</span>endTimeMillis <span class="token operator">-</span> start
  _         <span class="token keyword">&lt;-</span> tell<span class="token punctuation">(</span>s<span class="token string">&quot;Ran hello world in $durationInMs ms.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">yield</span> either
</code></pre><p>It&#x27;s almost as if someone put together <code>Reader</code>, <code>Writer</code> and <code>Either</code> and combined them together into one monad. We simply <code>ask</code> the <code>Reader</code> for the config, catch <code>println</code> errors with <code>catchNonFatalThrowable</code>, and <code>tell</code> <code>Writer</code> to write our running time to some log.</p><p>Finally, let&#x27;s go take a look at <code>main</code>.</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> program <span class="token operator">=</span> printHelloWorld<span class="token punctuation">[</span>Stack<span class="token punctuation">]</span>

  <span class="token comment">// at the end of the world</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> Either<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    program
      <span class="token punctuation">.</span>runReader<span class="token punctuation">(</span>AppConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>runWriterUnsafe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>println<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>runEither
      <span class="token punctuation">.</span>run

  result <span class="token keyword">match</span> <span class="token punctuation">{</span> <span class="token comment">// Our program&#x27;s result is a side effect that can fail.</span>
    <span class="token keyword">case</span> Left<span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
      println<span class="token punctuation">(</span>s<span class="token string">&quot;Hello world failed: $e&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>We first let <code>printHelloWorld</code> know it runs under a stack of effects as specified earlier in our <code>Stack</code> type. At the end of the world, we run our effects exactly in the order shown above. Remember, we need to <code>runReader</code> before <code>runWriterUnsafe</code> because our usage of the <code>Writer</code> effect in <code>printHelloWorld</code> depends on there being an <code>AppConfig</code>, i.e. it needs to get the current time to write <code>println</code>&#x27;s running time.</p><p>Note that <code>runWriterUnsafe</code> means we can just write our logs in a function with side effects, e.g. <code>println</code> to console. You can choose to log this anywhere. Very handy when you have to log a lot of stuff and you don&#x27;t want your logs to eat up all your RAM like Google Chrome does. When we <code>runEither</code>, we&#x27;re left with only one effect, <code>Eff</code>. You can think of <code>Eff</code> as an effect that combines other effects. We finally get <code>result</code> with the last <code>run</code>.</p><p>Our final act in <code>main</code> is handling any errors that might have occurred while trying to print <code>&quot;Hello World&quot;</code>. <code>e</code> in <code>Left(e)</code> contains our possible error while <code>Right</code> only contains <code>Unit</code>, which we can just ignore.</p><p>Looking at <code>main</code>, we get the notion that the entire goal of our program is to produce a side effect, which can fail non-fatally.</p><p>How do we test our Eff program? We just interpret it a different way.</p><pre class="language-scala"><code class="language-scala" metaString=""><span class="token string">&quot;our eighth pass printHelloWorld Eff monad program&quot;</span> should
  <span class="token string">&quot;be flexible, timed, and resilient&quot;</span> in <span class="token punctuation">{</span>
  <span class="token keyword">val</span> program <span class="token operator">=</span> Prob01Pass08<span class="token punctuation">.</span>printHelloWorld<span class="token punctuation">[</span>Prob01Pass08<span class="token punctuation">.</span>Stack<span class="token punctuation">]</span>

  <span class="token keyword">val</span> runningMock<span class="token operator">:</span> AppConfig <span class="token operator">=</span> MockAppConfig
  <span class="token keyword">val</span> failingMock<span class="token operator">:</span> AppConfig <span class="token operator">=</span> MockUnreachableRover

  program
    <span class="token punctuation">.</span>runReader<span class="token punctuation">(</span>runningMock<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>runWriter
    <span class="token punctuation">.</span>runEither
    <span class="token punctuation">.</span>run should be <span class="token punctuation">(</span>Right<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> List<span class="token punctuation">(</span><span class="token string">&quot;Ran hello world in 2 ms.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  program
    <span class="token punctuation">.</span>runReader<span class="token punctuation">(</span>failingMock<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>runWriter
    <span class="token punctuation">.</span>runEither
    <span class="token punctuation">.</span>run should be <span class="token punctuation">(</span>Left<span class="token punctuation">(</span>MockUnreachableRover<span class="token punctuation">.</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h1>Conclusion</h1><p>FP can be difficult without the proper abstractions. Even Hello World can get unwieldy. That isn&#x27;t to say our FP versions are invariably harder than procedural code or &quot;mainstream&quot; OOP equivalents. Indeed these versions can yield even more difficult, opaque code.</p><p>Our pure programs, however, are highly composable, easier to reason about, and can very easily be made asynchronous, concurrent, and parallel just by adding some <code>Task</code> or <code>Future</code> effect on the stack and in our pure program&#x27;s code. It&#x27;s just not as easy to do the same in procedural/OOP code. To see this in action, if this article has helped you understand the whole point of the Eff monad, I strongly suggest you move on to working on the excellent exercises in Ben Hutchinson&#x27;s <a href="https://github.com/benhutchison/GettingWorkDoneWithExtensibleEffects/"><em>&quot;Getting Work Done With Extensible Effects&quot;</em></a>.</p><p>There are two other ways to express our stack that I didn&#x27;t include here for lack of time. One way is with the free monad and the other is by rolling out your own <code>ReaderWriterEither[R, T, L, A]</code> type which effectively lets you have the same level of abstraction as with Eff. I leave these two as exercises for the reader.</p></div></div><footer class="jsx-1238384267"><div class="jsx-1238384267 post-pagination"><a class="jsx-3237423915" href="/posts/learning-refined-types-in-scala"><small class="jsx-3237423915">Read <!-- -->previous<!-- --> post </small>Learning Refined Types in Scala</a></div></footer></article></main><footer class="jsx-3055961061"><div class="jsx-140955737 h-card profile"><img src="/static/chibi.png" alt="Zachary Albia" class="jsx-140955737 u-photo"/><div class="jsx-140955737"><p class="jsx-140955737">Hi, I&#x27;m<!-- --> <a href="https://zach-albia.github.io" rel="me" class="jsx-140955737 u-url p-name">Zachary Albia</a>.</p><p class="jsx-140955737 p-note">Functional programming, Scala and TypeScript have been my focus lately.</p></div></div><p class="jsx-3055961061">Proudly built with <a href="https://nextjs.org" class="jsx-3055961061">Next.js</a> -<!-- --> <!-- -->© 2020 Zachary Albia. All rights reserved.</p></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/posts/learning-eff","query":{},"buildId":"j1ueu67XSefpcnR98rryX","nextExport":true,"autoExport":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-f4f9c501a023823ba3a2.js"></script><script async="" data-next-page="/posts/learning-eff" src="/_next/static/j1ueu67XSefpcnR98rryX/pages/posts/learning-eff.js"></script><script async="" data-next-page="/_app" src="/_next/static/j1ueu67XSefpcnR98rryX/pages/_app.js"></script><script src="/_next/static/runtime/webpack-91b117697e716c22a78b.js" async=""></script><script src="/_next/static/chunks/framework.74d547792b3163b4d6d2.js" async=""></script><script src="/_next/static/chunks/commons.6b5b42654657d9aebcbb.js" async=""></script><script src="/_next/static/runtime/main-585248bbf88b18432f6a.js" async=""></script><script src="/_next/static/chunks/96b6526e.a10b20af608fdac87cca.js" async=""></script><script src="/_next/static/chunks/f549ad2dcf6c9c5ffbba747589d169db97ccff2b.5903a973e4c876611b30.js" async=""></script><script src="/_next/static/chunks/f041c2740afecc650b3ad9ef54274eb23f155db1.ede9e800f277f0f3ce47.js" async=""></script><script src="/_next/static/j1ueu67XSefpcnR98rryX/_buildManifest.js" async=""></script></body></html>